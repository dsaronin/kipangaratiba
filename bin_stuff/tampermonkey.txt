// ==UserScript==
// @name         Jitsi Auto Join/Hangup (v1.4 - robust polling)
// @namespace    http://tampermonkey.net/
// @version      1.4
// @description  Auto joins, then auto-hangs up based on a room name-to-duration map.
// @author       Angalia Developer
// @match        https://meet.jit.si/*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';
    console.log('[Angalia Script] v1.4 START');

    // --- CONFIGURATION ---
    const DEFAULT_DURATION_SECONDS = 3600; // 60 minutes
    
    // Hash map of Room Name => Duration in Seconds
    const DURATION_MAP = {
        "SchFrry102VisitSA": 4500,  // 75 * 60
        "EllesGantesGS1976": 5400,  // 90 * 60
        "ShortSelmaSession5145": 1800   // 30 * 60
    };

    // --- XPATH SELECTORS ---
    const xpaths = {
        join: "//div[@role='button' and contains(translate(., 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'join meeting')]",
        // login: "//button[@data-testid='lobby.loginButton']",
        login: "//button[@data-testid='lobby.loginButton' or contains(., 'Log-in')]",
        hangup: "//div[contains(@class, 'toolbox-icon') and contains(@class, 'hangup-button')]"
    };

    // --- STATE MACHINE FOR POLLING ---
    let pollInterval = null;
    let safetyTimeout = null;
    let pollerState = null; 

function startPoller(initialState) {
        if (pollInterval) clearInterval(pollInterval);
        if (safetyTimeout) clearTimeout(safetyTimeout);

        pollerState = initialState;
        let targetXPath = '';
        console.log(`[Angalia Script] Starting poller for: ${pollerState}`);

        // --- Configure the target for simple states ---
        if (pollerState === 'POLL_FOR_JOIN') {
            targetXPath = xpaths.join;
        } else if (pollerState === 'POLL_FOR_HANGUP') {
            targetXPath = xpaths.hangup;
        } else if (pollerState !== 'POLL_FOR_POST_JOIN') {
            console.log(`[Angalia Script] Unknown state, stopping.`);
            return;
        }

        // --- Safety Timeout ---
        safetyTimeout = setTimeout(() => {
            console.log(`[Angalia Script] Poller for ${pollerState} TIMED OUT after 30s.`);
            clearInterval(pollInterval);
        }, 600000);

        // --- Polling Interval ---
        pollInterval = setInterval(() => {
            try {
                // --- SPECIAL LOGIC FOR POST-JOIN ---
                // This state waits for EITHER the lobby OR the meeting to load.
                if (pollerState === 'POLL_FOR_POST_JOIN') {
                    let loginBtn = document.evaluate(xpaths.login, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
                    let hangupBtn = document.evaluate(xpaths.hangup, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;

                    if (loginBtn) {
                        console.log(`[Angalia Script] Found and clicking: POLL_FOR_LOGIN (lobby)`);
                        loginBtn.click();
                        clearInterval(pollInterval);
                        clearTimeout(safetyTimeout);
                        console.log('[Angalia Script] Join/Login sequence complete.');
                  } else if (hangupBtn) {
                        console.log(`[Angalia Script] Successfully joined meeting (hangup button found).`);
                        clearInterval(pollInterval);
                        clearTimeout(safetyTimeout);
                        console.log('[Angalia Script] Join sequence complete (no lobby).');
                    }
                    // If neither is found, the interval continues.

                // --- STANDARD LOGIC for other states ---
                } else {
                    let result = document.evaluate(targetXPath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
                    let button = result.singleNodeValue;

                    if (button) {
                        console.log(`[Angalia Script] Found and clicking: ${pollerState}`);
                        button.click();
                        clearInterval(pollInterval);
                        clearTimeout(safetyTimeout);

                        if (pollerState === 'POLL_FOR_JOIN') {
                            console.log('[Angalia Script] Join clicked. Now polling for Post-Join (Lobby or Hangup).');
                            // NO TIMEOUT. Immediately start the next poller.
                            startPoller('POLL_FOR_POST_JOIN');
                        } else if (pollerState === 'POLL_FOR_HANGUP') {
                            console.log('[Angalia Script] Hangup complete.');
                        }
                    }
                }
            } catch (e) {
                console.error('[Angalia Script] Poller error:', e);
                clearInterval(pollInterval);
              clearTimeout(safetyTimeout);
            }
        }, 500);
    }

    // --- HANGUP TIMER ---
    function setupHangupTimer() {
        let hangupDuration = DEFAULT_DURATION_SECONDS;
        try {
            // Get room name from URL path (e.g., /SchFrry102VisitSA)
            const roomName = window.location.pathname.substring(1);

            if (DURATION_MAP.hasOwnProperty(roomName)) {
                hangupDuration = DURATION_MAP[roomName];
                console.log(`[Angalia Script] Found room '${roomName}' in map. Setting duration to ${hangupDuration}s.`);
            } else {
                console.log(`[Angalia Script] Room '${roomName}' not in map. Using default ${hangupDuration}s.`);
            }
            
            const durationMs = hangupDuration * 1000;
            
            setTimeout(() => {
                console.log(`[Angalia Script] HANGUP TIMER FIRED after ${hangupDuration}s. Starting hangup poller.`);
                startPoller('POLL_FOR_HANGUP');
            }, durationMs);

        } catch (e) {
            console.error('[Angalia Script] Failed to parse room/duration:', e);
        }
    }

    // --- START ---
    startPoller('POLL_FOR_JOIN');
    setupHangupTimer();

})();
